<%= simple_form_for :search, url: ceramics_path, method: "GET", html: { class: 'form-inline' } do |f| %>
  <%= f.input :publication_id,
          collection:
            Publication
              .accessible_by(current_ability)
              .order(:author, :year)
              .pluck(:author, :year, :id)
              .map { |author, year, id| ["#{author} #{year}", id] },
              include_blank: true,
              selected: params.dig(:search, :publication_id) %>
  <%= f.input :site_id, collection: Site.order(:name).pluck(:name, :id), selected: params.dig(:search, :site_id), include_blank: true %>
  <%= f.input :linked_to_grave, as: :boolean, input_html: { checked: params.dig(:search, :linked_to_grave) == '1' }  %>
  <%= f.submit "Filter", class: "btn btn-primary" %>
<% end %>

<table class='table'>
  <thead>
    <tr>
      <th>ID</th>
      <th>Image</th>
      <th>Grave</th>
      <th>Similar by Features</th>
      <th>Similar by EFDs</th>
    </tr>
  </thead>

  <tbody>
    <% @ceramics.each do |figure| %>
      <tr>
        <td><%= link_to "Ceramic #{figure.id}", ceramic_path(figure) %></td>
        <td><%= image_tag(preview_figure_path(figure), class: 'img-fluid', style: 'max-height: 120px') %></td>
        <td><%= link_to figure.good.grave.identifier, grave_update_grave_path(figure.good.grave, :set_grave_data) %></td>
        <td></td>
        <td>
          <% FeatureSimilarity.where(first: figure).where.not(second: figure).order(similarity: :desc).limit(5).each do |related| %>
            <div>
              <%#= related.second.type %><%#= related.second.id %> in <%#= link_to(related.second.grave.identifier, grave_path(related.second.grave))  %> (<%#= related.similarity.round(4) %>)
            </div>
            <% end %>
        </td>
        <td>
          <% EfdSimilarity.where(first: figure).where.not(second: figure).order(similarity: :desc).limit(5).each do |related| %>
            <div>
              <%#= related.second.type %><%#= related.second.id %> in <%#= link_to(related.second.grave.identifier, grave_path(related.second.grave))  %> (<%= related.similarity.round(4) %>)
            </div>
            <% end %>
        </td>
      </tr>
    <% end %>
  </tbody>
</table>

<%== pagy_bootstrap_combo_nav_js(@ceramics_pagy) %>
